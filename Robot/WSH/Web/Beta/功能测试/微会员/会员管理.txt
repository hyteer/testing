*** Settings ***
Suite Setup       登录
Suite Teardown    关闭浏览器
Test Teardown     失败重启
Library           Selenium2Library
Resource          ../../Resource/常用操作.robot
Resource          ../../Resource/功能菜单.robot
Resource          ../../Resource/配置参数.robot
Library           Screenshot
Resource          ../../Resource/API.robot

*** Test Cases ***
会员概况_页面检测
    [Documentation]    注：会员转化和开卡率计算待完成
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员概况
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"会员概况")]
    Sleep    1
    ####会员概况
    ##页面数据
    ${微客户总数}    Get Text    //div[@class="page-content"]//div[starts-with(@ng-bind,"wx_totalaa?wx_totalaa")]
    ${昨日新增客户数}    Get Text    //div[@class="page-content"]//div[starts-with(@ng-bind,"yestodayNewaa?yestodayNewaa")]
    ${会员总数}    Get Text    //div[@ng-bind="total_count?total_count:0"]
    ${昨日新增会员}    Get Text    //div[@ng-bind="new_count?new_count:0"]
    ${已开会员卡}    Get Text    //div[@ng-bind="opencount?opencount:0"]
    ${会员转化率}    Get Text    //span[@ng-bind="conversion?conversion:0"]
    ${会员开卡率}    Get Text    //span[@ng-bind="openCard?openCard:0"]
    #按微信客户转换
    Select From List By Label    //select[@ng-change="sendTypeDescCha(sendTypeDesc)"]    按微信客户转换
    Sleep    1.5
    ${微信客户总数}    Get Text    //div[@class="page-content"]//div[starts-with(@ng-bind,"wx_totalaa?wx_totalaa")]
    ${昨日新增微信客户数}    Get Text    //div[@class="page-content"]//div[starts-with(@ng-bind,"yestodayNewaa?yestodayNewaa")]
    ##查询API
    ${errmsg_客户统计}    API.客户统计
    ${客户总数_API}    Get From Dictionary    ${errmsg_客户统计}    total
    ${微信客户总数_API}    Get From Dictionary    ${errmsg_客户统计}    wx_total
    ${昨日新增客户_API}    Get From Dictionary    ${errmsg_客户统计}    yestodayNew
    ${昨日新增微信客户_API}    Get From Dictionary    ${errmsg_客户统计}    yestodayWxNew
    ${errmsg_会员统计}    API.会员统计
    ${会员总数_API}    Get From Dictionary    ${errmsg_会员统计}    total_count
    ${昨日新增会员_API}    Get From Dictionary    ${errmsg_会员统计}    last_day_count
    ${errmsg}    API.获取会员列表
    ${data}    Get From Dictionary    ${errmsg}    data
    ${page}    Get From Dictionary    ${errmsg}    page
    ${已开卡会员_API}    Get From Dictionary    ${page}    total_count
    ##校验
    Should Be Equal As Strings    ${微客户总数}    ${客户总数_API}
    Should Be Equal As Strings    ${微信客户总数}    ${微信客户总数_API}
    Should Be Equal As Strings    ${会员总数}    ${会员总数_API}
    Should Be Equal As Strings    ${昨日新增客户数}    ${昨日新增客户_API}
    Should Be Equal As Strings    ${昨日新增会员}    ${昨日新增会员_API}
    Should Be Equal As Strings    ${已开会员卡}    ${已开卡会员_API}
    Log    数据校验成功
    ####链接检查
    ##趋势统计    //span[contains(text(),"最近七天会员趋势图")]/a[text()="详细统计" and @href="../members/member-statistics"]
    Page Should Contain Element    //a[@href="../members/member-statistics" and text()="详细统计"]
    Page Should Contain Element    //span[contains(text(),"最近七天会员趋势图")]
    ##消费金额分层
    Page Should Contain Element    //span[contains(text(),"消费金额分层统计")]/following-sibling::a[text()="详细统计" and @href="../members/cons-statistics"]
    ##消费次数分层
    Page Should Contain Element    //span[contains(text(),"消费次数分层统计")]/following-sibling::a[text()="详细统计" and @href="../members/cons-statistics"]
    Log    Sucess!

会员分组_新增
    [Documentation]    注：会员转化和开卡率计算待完成
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员分组-新增
    Click Link    新增分组
    Wait Until Element Is Visible    //div[@class="modal-header"]/h4[text()="添加会员分组"]
    Sleep    1
    ${分组名}    随机字符    【测试组】    10
    ${排序}    Evaluate    random.randint(0,10)    random
    Input Text    //input[@ng-model="addName" and @placeholder="请输入分组组名，组名最多15个字"]    ${分组名}
    Input Text    //input[@name="sortName" \ and @placeholder="数字越小越靠前"]    ${排序}
    Sleep    1
    Click Element    //div[@class="modal-footer"]/a[@ng-click="add()" and text()="确定"]
    Sleep    1
    ####结果校验
    Wait Until Element Is Visible    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    3
    Page Should Contain Element    //tr[@ng-repeat="list in lists"]/td[text()="${分组名}"]
    Log    Sucess!

会员分组_编辑
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员分组-编辑
    ${els}    Get Matching Xpath Count    //tr[@ng-repeat="list in lists"]/td[starts-with(text(),"【测试组】")]/parent::tr[1]//a[@title="编辑"]
    ${rand}    Evaluate    random.randint(1,${els})    random
    Click Element    //tr[@ng-repeat="list in lists"]/td[starts-with(text(),"【测试组】")]/parent::tr[1]//a[@title="编辑"]
    Sleep    3
    Wait Until Element Is Visible    //div[@class="modal-header"]/h4[text()="編輯会员分组"]
    Sleep    1
    ${分组名}    随机字符    【测试组】改    10
    ${排序}    Evaluate    random.randint(0,10)    random
    Input Text    //input[@ng-model="editorName" and @placeholder="请输入分组名"]    ${分组名}
    Input Text    //input[@ng-model="editsort" \ and @placeholder="数字越小越靠前"]    ${排序}
    Sleep    1
    Click Element    //div[@class="modal-footer"]/a[@ng-click="editor()" and text()="确定"]
    Sleep    1
    ####结果校验
    Wait Until Element Is Visible    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    3
    Page Should Contain Element    //tr[@ng-repeat="list in lists"]/td[text()="${分组名}"]
    Log    Sucess!

会员分组_删除
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员分组-删除
    ${els}    Get Matching Xpath Count    //tr[@ng-repeat="list in lists"]/td[starts-with(text(),"【测试组】")]/parent::tr[1]//a[@title="删除"]
    ${rand}    Evaluate    random.randint(1,${els})    random
    ${分组名称}    Get Text    xpath=(//tr[@ng-repeat="list in lists"]/td[starts-with(text(),"【测试组】")]/parent::tr[1]/td[@ng-bind="list.name"])[${rand}]
    Click Element    xpath=(//tr[@ng-repeat="list in lists"]/td[starts-with(text(),"【测试组】")]/parent::tr[1]//a[@title="删除"])[${rand}]
    Sleep    3
    Wait Until Element Is Visible    //td[@i="header"]/div[@i="title" and text()="删除提示"]
    Sleep    1
    确认
    弹出信息校验
    ####结果校验
    Page Should Not Contain Element    //tr[@ng-repeat="list in lists"]/td[text()="${分组名称}"]

会员分组_搜索
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员分组-搜索
    ${关键字列表}    Create List    测试    【测试组】    不存在的关键字
    ${rand}    Generate Random String    1    1
    ${关键字}    Set Variable    ${关键字列表[${rand}]}
    Input Text    //input[@placeholder="搜索分组" and @type="text"]    ${关键字}
    Sleep    1
    Click Element    //a/i[contains(@class,"icon-search")]
    Sleep    3
    ####结果校验
    Run Keyword If    ${rand}==2    Element Should Contain    //*[@id="main-container"]//table/tbody/tr/td    暂时没有可展示的数据
    Run Keyword If    ${rand}==2    Pass Execution    搜索结果无数据
    ${数量1}    Get Matching Xpath Count    //*[@id="main-container"]//table/tbody/tr[@ng-repeat="list in lists"]
    ${数量2}    Get Matching Xpath Count    //*[@id="main-container"]//table/tbody/tr[@ng-repeat="list in lists"]/td[contains(text(),"${关键字}")]
    Should Be Equal As Strings    ${数量2}    ${数量1}
    Log    Sucess!

会员列表_页面检测
    [Tags]    ready
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员列表
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"会员列表")]
    Sleep    1
    ####会员列表-页面检测
    ##查询API
    ${errmsg_会员统计}    API.会员统计
    ${会员总数_API}    Get From Dictionary    ${errmsg_会员统计}    total_count
    ${昨日新增会员_API}    Get From Dictionary    ${errmsg_会员统计}    last_day_count
    ${errmsg}    API.获取会员列表
    ${data}    Get From Dictionary    ${errmsg}    data
    ${page}    Get From Dictionary    ${errmsg}    page
    ${已开卡会员_API}    Get From Dictionary    ${page}    total_count
    ##页面数据    \    //*[@id="main-container"]//div[contains(@class,"page-content")]//div[@class="tabbable"]//i/span[@ng-bind="total_count?total_count:0"]
    Sleep    1
    ${会员总数}    Get Text    //*[@id="main-container"]//div[contains(@class,"page-content")]//div[@class="tabbable"]//i/span[@ng-bind="total_count?total_count:0"]
    ${昨日新增}    Get Text    //*[@id="main-container"]//div[contains(@class,"page-content")]//div[@class="tabbable"]//i/span[@ng-bind="new_count?new_count:0"]
    ${当前页数量}    Get Matching Xpath Count    //*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]
    Should Be Equal As Strings    ${会员总数}    ${已开卡会员_API}
    Should Be Equal As Strings    ${昨日新增}    ${昨日新增会员_API}
    Run Keyword If    ${会员总数}>${当前页数量}    分页工具条校验    ${会员总数}
    :FOR    ${i}    IN RANGE    ${当前页数量}
    \    ${会员名}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td[@ng-bind="i.wxUserInfos.real_name"])[${i+1}]
    \    ${手机}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td[@ng-bind="i.wxUserInfos.bind_mobile"])[${i+1}]
    \    ${会员卡编号}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td[@ng-bind="i.member_no"])[${i+1}]
    \    ${积分}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td[@ng-bind="i.wxUserInfos.point"])[${i+1}]
    \    ${等级}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td[@ng-bind="i.memberGrade.name"])[${i+1}]
    \    ${会员分组}    Get Text    xpath=(//*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]/td/button[@ng-bind="i.memberGroup.name"])[${i+1}]
    \    ${会员数据_API}    Get From List    ${data}    ${i}
    \    ${wxUserInfos}    Get From Dictionary    ${会员数据_API}    wxUserInfos
    \    ${memberGrade}    Get From Dictionary    ${会员数据_API}    memberGrade
    \    ${memberGroup}    Get From Dictionary    ${会员数据_API}    memberGroup
    \    ${会员名_API}    Get From Dictionary    ${wxUserInfos}    real_name
    \    ${手机_API}    Get From Dictionary    ${wxUserInfos}    bind_mobile
    \    ${会员卡编号_API}    Get From Dictionary    ${会员数据_API}    member_no
    \    ${积分_API}    Get From Dictionary    ${wxUserInfos}    point
    \    ${等级_API}    Get From Dictionary    ${memberGrade}    name
    \    ${会员分组_API}    Get From Dictionary    ${memberGroup}    name
    \    Should Be Equal As Strings    ${会员名}    ${会员名_API}
    \    Should Be Equal As Strings    ${手机}    ${手机_API}
    \    Should Be Equal As Strings    ${会员卡编号}    ${会员卡编号_API}
    \    Should Be Equal As Strings    ${积分}    ${积分_API}
    \    Should Be Equal As Strings    ${等级}    ${等级_API}

会员列表_批量分组
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_统一打标签
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_导出
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_手动调整等级
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索
    ${当前页数量}    Get Matching Xpath Count    //*[@id="integralTable"]/tbody/tr[@ng-show="lists.length"]
    ${rand}    Evaluate    random.randint(1,${当前页数量})    random

会员列表_打标签
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_查看详情
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_冻结
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_调整积分
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_搜索
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-搜索

会员列表_高级搜索
    [Tags]
    ####进入页面
    点击链接菜单    微会员
    ${sub}    Set Variable    会员分组
    点击链接菜单    ${sub}
    Wait Until Page Contains Element    //*[@id="breadcrumbs"]/ul/li[contains(text(),"分组管理")]
    Sleep    1
    ####会员列表-高级搜索

*** Keywords ***
分页工具条校验
    [Arguments]    ${总数}
    Element Should Be Visible    //ul[@total-items="page.total_count"]
    ${总数_页面}    Get Text    //span[@ng-bind="page.total_count"]
    Should Be Equal As Strings    ${总数_页面}    ${总数}
    Log    校验成功！
